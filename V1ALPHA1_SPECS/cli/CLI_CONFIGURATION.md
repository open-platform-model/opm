# OPM CLI Configuration Guide

**Version:** 1.1.0
**Status:** Draft
**Last Updated:** 2025-11-06

---

## Overview

OPM CLI configuration follows a layered priority system with explicit, user-visible defaults. All configuration is stored in `~/.opm/` as a CUE module, making it fully inspectable and editable.

**Design Philosophy:** No hidden or hardcoded configuration. All defaults are written to `config.cue` on initialization, ensuring transparency and user control.

---

## Configuration Directory Structure

The OPM configuration is stored as a full CUE module in `~/.opm/`. This directory is **automatically generated** on first CLI use or via `opm config init`.

```text
~/.opm/
├── cue.mod/
│   └── module.cue      # CUE module definition
├── config.cue          # Main configuration (all defaults written here)
└── credentials         # Sensitive credentials (kubectl-style, optional)
```

### Auto-Generation

The configuration directory and default `config.cue` file are created automatically when:

1. You run any OPM command for the first time
2. You explicitly run `opm config init`

This ensures users always have a visible, editable configuration file.

---

## Configuration File Structure

### Example `config.cue` (auto-generated)

```cue
package opmconfig

// OPM CLI Configuration
// ======================
// This file is auto-generated by 'opm config init'
// Edit values below to customize your OPM CLI experience

config: {
    // Registry Configuration
    // URL to the OCI registry for module/bundle publishing and retrieval
    registry: {
        url: "localhost:5000"
    }

    // Definition Sources
    // Configures where OPM loads resource, trait, blueprint, and policy definitions
    definitions: {
        // CUE module containing definitions (string reference)
        // The CLI loads this module and extracts the #Registry
        module: "opm.dev@v1"

        // Optional: Local file path for development
        // When set, CUE module resolution will prefer this path over published modules
        // This allows testing local changes before publishing
        // path: "/path/to/local/opm/v1"
    }

    // Cache Configuration
    cache: {
        enabled: true
        ttl:     "24h"
    }

    // Logging Configuration
    log: {
        level:  "info"   // debug|info|warn|error
        format: "text"   // text|json
    }
}
```

### Configuration Keys

| Key | Type | Description | Default |
|-----|------|-------------|---------|
| `config.registry.url` | string | OCI registry URL for module/bundle publishing | `localhost:5000` |
| `config.definitions.module` | string | CUE module containing core definitions | `opm.dev@v1` |
| `config.definitions.path` | string (optional) | Local path override for definition loading | - |
| `config.cache.enabled` | bool | Enable local caching | `true` |
| `config.cache.ttl` | duration | Cache time-to-live | `24h` |
| `config.log.level` | string | Logging level (debug\|info\|warn\|error) | `info` |
| `config.log.format` | string | Log output format (text\|json) | `text` |

### Registry vs Definitions

**Important Distinction:**

- **`registry.url`**: Used for **publishing and retrieving** OPM modules/bundles to/from OCI registries
- **`definitions.module` + `definitions.path`**: Used for **loading** resource, trait, blueprint, and policy definitions

This separation allows:

- Publishing modules to any OCI registry
- Loading definitions from local development paths
- Clean separation of concerns

**CUE Integration:**

Some OPM commands delegate to external CUE binary and automatically configure it to use OPM's registry:

- **`opm mod tidy`**: Wraps `cue mod tidy` and sets `CUE_REGISTRY` environment variable to `registry.url`
- This ensures CUE uses OPM's configured registry instead of its default central registry
- The registry URL flows: `config.registry.url` → `CUE_REGISTRY` env var → CUE binary

**Example:**
```bash
# OPM config shows
opm config show
# Registry:
#   URL: localhost:5000

# When you run
opm mod tidy

# OPM internally executes
CUE_REGISTRY=localhost:5000 cue mod tidy
```

**See:** [CLI Implementation Decisions - CUE Binary Delegation](CLI_IMPLEMENTATION_DECISIONS.md#cue-module-operations---external-binary-delegation) for details

---

## Configuration Priority

Configuration values are resolved in the following priority order (highest to lowest):

1. **Command-line flags** - Explicit flags passed to commands
2. **Environment variables** - `OPM_*` prefixed variables
3. **`~/.opm/config.cue`** - User configuration with written defaults
4. ❌ **No hardcoded defaults** - All defaults must be explicit in `config.cue`

### Example Priority Resolution

```bash
# Priority 1: CLI flag (highest)
opm mod render . --verbose

# Priority 2: Environment variable
export OPM_REGISTRY_URL=localhost:5000
opm mod render .

# Priority 3: config.cue setting
# config.cue: config.registry.url: "localhost:5000"
opm mod render .
```

---

## Environment Variables

OPM CLI respects the following environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `OPM_CONFIG_PATH` | Config directory location | `~/.opm` |
| `OPM_REGISTRY_URL` | OCI registry URL (overrides `config.registry.url`) | Read from `~/.opm/config.cue` |
| `OPM_DEFINITIONS_MODULE` | Definitions module reference (overrides `config.definitions.module`) | Read from `~/.opm/config.cue` |
| `OPM_DEFINITIONS_PATH` | Local definitions path override (overrides `config.definitions.path`) | - |
| `OPM_CACHE_DIR` | Cache directory | `~/.cache/opm` (Linux/Mac)<br>`%LOCALAPPDATA%\opm\cache` (Windows) |
| `OPM_LOG_LEVEL` | Log level (overrides `config.log.level`) | Read from `~/.opm/config.cue` |
| `OPM_LOG_FORMAT` | Log format (overrides `config.log.format`) | Read from `~/.opm/config.cue` |
| `NO_COLOR` | Disable colored output | - |
| `EDITOR` | Editor for `config edit` | `vim`, `nano`, or `vi` |

### Registry Configuration

**OPM uses `OPM_REGISTRY_URL` (not `CUE_REGISTRY`)** for consistency and clarity:

- `OPM_REGISTRY_URL`: For publishing/retrieving OPM modules
- `OPM_DEFINITIONS_MODULE`: For specifying which definitions module to load
- `OPM_DEFINITIONS_PATH`: For local development of definitions

**Registry Selection Priority:**

1. `OPM_REGISTRY_URL` environment variable (highest priority)
2. `~/.opm/config.cue` → `config.registry.url` field
3. No fallback - if not configured, error with helpful message

**CUE_REGISTRY Usage:**

- **Do not set manually**: OPM automatically sets `CUE_REGISTRY` when delegating to external CUE commands
- **Read-only for users**: When `opm mod tidy` calls `cue mod tidy`, it sets `CUE_REGISTRY` from OPM's config
- **Automatic override**: Any manual `CUE_REGISTRY` setting will be overridden by OPM commands
- **Purpose**: Ensures CUE uses the same registry as OPM for consistency

### Local Development Workflow

Use `OPM_DEFINITIONS_PATH` or `config.definitions.path` to test local definition changes:

```bash
# Option 1: Environment variable
export OPM_DEFINITIONS_PATH=/path/to/local/opm/v1
opm mod render ./my-module

# Option 2: config.cue (persistent)
# Edit ~/.opm/config.cue
config: {
    definitions: {
        module: "opm.dev@v1"
        path: "/path/to/local/opm/v1"
    }
}
```

---

## Cache Configuration

### Cache Locations (Platform-Specific)

**Linux/Mac:** `~/.cache/opm` (follows XDG Base Directory specification)

**Windows:** `%LOCALAPPDATA%\opm\cache`

### Cache Structure

```text
~/.cache/opm/
├── registry/          # Definition registry cache (Resources, Traits, Blueprints)
├── modules/           # Downloaded modules
└── oci/               # OCI registry metadata
```

### Cache Management Commands

```bash
# Clear all caches
opm registry cache clear

# Show cache status and statistics
opm registry cache status

# Show cache directory location
opm registry cache path
```

### Configuring Cache Behavior

Edit `~/.opm/config.cue`:

```cue
config: {
    cache: {
        enabled: true    // Enable/disable caching
        ttl:     "24h"   // How long to keep cached items
    }
}
```

Or use environment variable:

```bash
# Override cache directory
export OPM_CACHE_DIR=/custom/cache/path
```

---

## Credential Management

### OCI Registry Credentials

**Primary Method (Recommended):**

OPM automatically reads OCI registry credentials from Docker's standard configuration file:

```text
~/.docker/config.json
```

This file is managed by Docker/Podman and works with standard authentication flows:

```bash
# Login using Docker CLI (credentials stored in ~/.docker/config.json)
docker login registry.opm.dev

# OPM will automatically use these credentials
opm mod publish ./my-module oci://registry.opm.dev/org/my-module:v1.0.0
```

**OPM Native Login:**

OPM also provides its own login command:

```bash
# Login with OPM CLI
opm registry login registry.opm.dev --username myuser

# With password from stdin (recommended for CI/CD)
echo "$REGISTRY_PASSWORD" | opm registry login registry.opm.dev --username myuser --password-stdin
```

### Other Credentials (Optional)

For non-OCI credentials (API keys, tokens, etc.), store in `~/.opm/credentials`:

```text
~/.opm/credentials
```

**Format:** Base64 encoded, kubectl-style

**Example credentials file:**

```yaml
apiVersion: v1
kind: Config
credentials:
- name: my-api-key
  credential:
    token: <base64-encoded-token>
```

---

## Configuration Management Commands

### Initialize Configuration

```bash
# Initialize config directory and default config.cue
opm config init

# Force reinitialize (overwrites existing)
opm config init --force
```

### Display Configuration

```bash
# Show all configuration
opm config show

# Show config directory path
opm config show --path

# Show as JSON
opm config show --format json

# Show as YAML
opm config show --format yaml
```

**Example output:**

```text
OPM CLI Configuration
=====================

Registry:
  URL:     localhost:5000

Definitions:
  Module:  opm.dev@v1
  Path:    /home/user/dev/opm/v1

Cache:
  Enabled: true
  Dir:     /home/user/.cache/opm
  TTL:     24h

Log:
  Level:   info
  Format:  text

Environment Overrides:
  OPM_DEFINITIONS_PATH=/home/user/dev/opm/v1 (overriding definitions.path)
```

### Set Configuration Values

```bash
# Set registry URL
opm config set registry.url localhost:5000

# Set definitions module
opm config set definitions.module opm.dev@v1

# Set definitions path (local development)
opm config set definitions.path /path/to/local/opm/v1

# Enable cache
opm config set cache.enabled true

# Set cache TTL
opm config set cache.ttl 24h

# Set log level
opm config set log.level debug
```

### Get Configuration Values

```bash
# Get registry URL
opm config get registry.url

# Get definitions module
opm config get definitions.module

# Get cache enabled status
opm config get cache.enabled

# Get log level
opm config get log.level
```

### Unset Configuration Values

```bash
# Unset registry URL (removes from config.cue)
opm config unset registry.url

# Unset definitions path (falls back to module only)
opm config unset definitions.path

# Unset cache TTL
opm config unset cache.ttl
```

### Edit Configuration File

```bash
# Open config.cue in editor (uses $EDITOR)
opm config edit
```

Uses `$EDITOR` environment variable, falls back to `vim`, `nano`, or `vi`.

---

## Implementation Approach

### Loading Configuration

OPM uses CUE's native capabilities to load and validate configuration:

```go
// Pseudo-code for configuration loading
func LoadConfig() (*Config, error) {
    // 1. Load CUE configuration from ~/.opm/config.cue
    configPath := getConfigPath() // Respects OPM_CONFIG_PATH
    ctx := cuecontext.New()
    config := ctx.CompileFiles(configPath + "/config.cue")

    // 2. Validate against config schema
    if err := config.Validate(); err != nil {
        return nil, fmt.Errorf("invalid config: %w", err)
    }

    // 3. Apply environment variable overrides
    applyEnvOverrides(config)

    // 4. Return typed config struct
    return config, nil
}
```

### Configuration Generation

On first use or `opm config init`:

```go
func InitConfig(force bool) error {
    configDir := getConfigPath()

    // Check if already exists
    if exists(configDir) && !force {
        return fmt.Errorf("config already exists, use --force to overwrite")
    }

    // Create directory structure
    os.MkdirAll(configDir + "/cue.mod", 0755)

    // Write module.cue
    writeFile(configDir + "/cue.mod/module.cue", moduleTemplate)

    // Write config.cue with ALL defaults explicitly written
    writeFile(configDir + "/config.cue", configTemplate)

    return nil
}
```

### No Viper Dependency

Unlike traditional Go CLIs, OPM doesn't need Viper because:

1. Configuration is already in CUE format
2. CUE SDK provides loading and validation
3. Simpler dependency tree
4. Native schema validation

---

## XDG Compliance

OPM follows the [XDG Base Directory Specification](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html) on Linux/Mac:

| Purpose | Location | Environment Variable |
|---------|----------|---------------------|
| Configuration | `~/.opm/` or `$XDG_CONFIG_HOME/opm/` | `OPM_CONFIG_PATH` or `XDG_CONFIG_HOME` |
| Cache | `~/.cache/opm/` or `$XDG_CACHE_HOME/opm/` | `OPM_CACHE_DIR` or `XDG_CACHE_HOME` |
| Data | `~/.local/share/opm/` or `$XDG_DATA_HOME/opm/` | (Future use) |

**Windows:**

- Configuration: `%APPDATA%\opm\`
- Cache: `%LOCALAPPDATA%\opm\cache\`

---

## Best Practices

### For Users

1. **Review defaults after installation**:
   ```bash
   opm config init
   cat ~/.opm/config.cue
   ```

2. **Use environment variables in CI/CD**:
   ```bash
   export OPM_REGISTRY_URL=ci-registry.internal
   export OPM_LOG_LEVEL=debug
   ```

3. **Keep credentials out of config.cue**:
   - Use `~/.docker/config.json` for OCI registries
   - Use `~/.opm/credentials` for other secrets

4. **Version control your config**:
   ```bash
   # Safe to commit (no secrets)
   git add ~/.opm/config.cue

   # Never commit credentials
   echo "~/.opm/credentials" >> .gitignore
   ```

5. **Use local development workflow**:
   ```bash
   # Set local definitions path for development
   export OPM_DEFINITIONS_PATH=/path/to/local/opm/v1
   opm mod render ./my-module
   ```

### For Platform Teams

1. **Provide pre-configured config templates**:
   ```bash
   # Distribute company-wide config
   curl -o ~/.opm/config.cue https://internal/opm-config.cue
   ```

2. **Use environment variables for dynamic config**:
   ```bash
   # In deployment scripts
   export OPM_REGISTRY_URL=${ENVIRONMENT}-registry.company.com
   ```

3. **Document custom configuration**:
   ```cue
   // ~/.opm/config.cue
   package opmconfig

   // Company-specific configuration
   // Maintained by Platform Team
   // Last updated: 2025-11-06

   config: {
       registry: {
           url: "registry.company.internal"
       }
       definitions: {
           module: "company.internal/opm@v1"
       }
       cache: {
           enabled: true
           ttl:     "48h"  // Longer TTL for internal network
       }
   }
   ```

4. **Provide local development setup**:
   ```bash
   # For teams developing custom definitions
   export OPM_DEFINITIONS_PATH="$HOME/work/opm-definitions"
   ```

---

## Troubleshooting

### Config not found

```bash
$ opm mod render .
Error: Config not found at ~/.opm/config.cue

Solution:
$ opm config init
✓ Config initialized at ~/.opm/
```

### Invalid config syntax

```bash
$ opm config show
Error: Invalid CUE syntax in config.cue:
  line 5: expected '}', found ','

Solution: Edit config.cue and fix syntax errors
$ opm config edit
```

### Registry not configured

```bash
$ opm mod publish ./my-module org/my-module:v1.0.0
Error: No registry configured. Set OPM_REGISTRY_URL or config.registry.url

Solution 1 (environment variable):
$ export OPM_REGISTRY_URL=localhost:5000

Solution 2 (config file):
$ opm config set registry.url localhost:5000
```

### Definitions not loading

```bash
$ opm mod render .
Error: Failed to load definitions from opm.dev@v1

Solution 1 (use local definitions):
$ export OPM_DEFINITIONS_PATH=/path/to/local/opm/v1

Solution 2 (check definitions module):
$ opm config get definitions.module
opm.dev@v1

# Verify the module exists
$ ls $OPM_DEFINITIONS_PATH
```

### Cache issues

```bash
# Clear cache
$ opm registry cache clear

# Disable cache temporarily
$ opm mod render . --no-cache

# Disable cache permanently
$ opm config set cache.enabled false
```

### Local development not working

```bash
# Verify definitions path is set
$ opm config show
Definitions:
  Module:  opm.dev@v1
  Path:    /path/to/local/opm/v1

# Verify path exists and contains definitions
$ ls $OPM_DEFINITIONS_PATH/units
$ ls $OPM_DEFINITIONS_PATH/traits
$ ls $OPM_DEFINITIONS_PATH/blueprints
$ ls $OPM_DEFINITIONS_PATH/policies

# Check environment override
$ echo $OPM_DEFINITIONS_PATH
/path/to/local/opm/v1
```

---

## Configuration Schema

The configuration file must conform to the following CUE schema (defined in `v1/schemas/config.cue`):

```cue
#Config: {
    // Registry Configuration
    // URL to the OCI registry for module/bundle publishing and retrieval
    registry: {
        url: string | *"localhost:5000"
    }

    // Definition Sources
    // Configures where OPM loads resource, trait, blueprint, and policy definitions
    definitions: {
        // CUE module containing definitions (string reference)
        // The CLI loads this module and extracts the #Registry
        // Example: "opm.dev@v1"
        module: string | *"opm.dev@v1"

        // Optional: Local file path override for development
        // When set, CUE module resolution will prefer this path
        // Example: "/path/to/local/opm/v1"
        path?: string
    }

    // Cache Configuration
    cache: {
        enabled: bool | *true
        ttl:     string | *"24h"
    }

    // Logging Configuration
    log: {
        level:  "debug" | "info" | "warn" | "error" | *"info"
        format: "text" | "json" | *"text"
    }
}
```

---

## CUE Integration

Some OPM commands delegate to the external CUE binary to leverage CUE's module management capabilities. These commands automatically configure CUE to use OPM's registry configuration.

### Commands Using CUE Delegation

**`opm mod tidy`:**

- Wraps `cue mod tidy` for dependency management
- **Requires**: CUE v0.15.0+ installed and in PATH
- **Version checking**: Validates CUE version before delegation
- **Registry override**: Sets `CUE_REGISTRY` environment variable from OPM config

**Configuration Flow:**

```
OPM Config                    CUE Binary
  ↓                              ↓
config.registry.url     →   CUE_REGISTRY env var
  ↓                              ↓
localhost:5000          →   cue mod tidy --registry localhost:5000
```

### Version Requirements

**Minimum CUE Version**: v0.15.0

**Version Checking Behavior:**

- **< v0.15.0**: Error with installation instructions
- **v0.15.x**: Supported (tested version)
- **> v0.15.x**: Warning about untested version, continues execution
- **dev builds**: Treated as compatible

**Example Version Check:**

```bash
# Check CUE version
cue version
# Output: cue version v0.15.0

# OPM validates before running
opm mod tidy

# If incompatible:
# Error: incompatible CUE version: v0.14.0
#
# OPM requires CUE v0.15.0 or newer.
# Install: go install cuelang.org/go/cmd/cue@v0.15.0
```

### Registry Configuration

**Automatic Registry Override:**

When `opm mod tidy` calls `cue mod tidy`, it automatically sets the `CUE_REGISTRY` environment variable:

```bash
# User runs
opm mod tidy

# OPM internally executes
export CUE_REGISTRY=localhost:5000  # From config.registry.url
cue mod tidy
```

**Priority:**

1. `OPM_REGISTRY_URL` environment variable
2. `config.registry.url` from `~/.opm/config.cue`
3. No fallback (error if not configured)

### Binary Detection

**PATH Requirement:**

OPM searches for the `cue` binary in the system PATH:

```bash
# Check if CUE is available
which cue
# /usr/local/bin/cue

# If not found:
# Error: cue binary not found in PATH
#
# CUE is required for 'opm mod tidy'.
# Install from: https://cuelang.org/docs/install/
```

### Error Handling

**Comprehensive Error Messages:**

OPM provides helpful error messages for common issues:

1. **CUE not installed**: Installation instructions with download URL
2. **Incompatible version**: Current vs required version with upgrade command
3. **Not in module directory**: Instructions to navigate to module root
4. **CUE execution failure**: Original CUE error message passed through

**See:**

- [CLI Specification - opm mod tidy](../CLI_SPEC.md#opm-mod-tidy) for user-facing documentation
- [CLI Implementation Decisions - CUE Binary Delegation](CLI_IMPLEMENTATION_DECISIONS.md#cue-module-operations---external-binary-delegation) for implementation details

---

## Related Documentation

- [CLI Specification](../CLI_SPEC.md) - Full CLI reference
- [Module Structure Guide](MODULE_STRUCTURE_GUIDE.md) - Directory organization
- [CLI Workflows](CLI_WORKFLOWS.md) - Common usage patterns

---

**Document Version:** 1.1.0-draft
**Date:** 2025-11-06
**Changes from 1.0.0:**

- Updated config structure to use `registry.url` (instead of `registry.default`)
- Added `definitions.module` and `definitions.path` configuration
- Updated environment variables (OPM_REGISTRY_URL, OPM_DEFINITIONS_MODULE, OPM_DEFINITIONS_PATH)
- Clarified distinction between registry (publishing) and definitions (loading)
- Added local development workflow examples
- Updated all code examples to reflect new structure
