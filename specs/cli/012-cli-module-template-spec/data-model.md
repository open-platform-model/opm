# Template File Specifications

**Specification**: [spec.md](./spec.md)  
**Version**: Draft  
**Last Updated**: 2026-01-23

## Overview

This document defines the content and structure of each file generated by the `opm mod init --template` command. Each template produces valid CUE files that pass `opm mod vet` immediately after generation.

## 1. Template Placeholders

The following placeholders are substituted during `opm mod init`:

| Placeholder | Source | Default |
|-------------|--------|---------|
| `{{.ModuleName}}` | `--name` flag or directory name | Directory name |
| `{{.ModulePath}}` | `--module` flag or derived | `example.com/<dirname>` (hyphens â†’ underscores) |
| `{{.Version}}` | Hardcoded | `0.1.0` |

---

## 2. Common Files (All Templates)

### 2.1. CUE Module Definition (`cue.mod/module.cue`)

**Purpose**: Standard CUE module definition for dependency management.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `module` | `string` | Module path (e.g., `"{{.ModulePath}}"`) |
| `language.version` | `string` | CUE language version (e.g., `"v0.11.0"`) |

**Structure**:

```cue
module: "{{.ModulePath}}"

language: version: "v0.11.0"

deps: {
    "opm.dev/core@v0": _
}
```

---

### 2.2. Default Values (`values.cue`)

**Purpose**: Concrete default values satisfying the module's `#spec` schema.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package main` |
| `values` | `struct` | Concrete values matching `#spec` |

**Structure**:

```cue
package main

values: {
    // Concrete values for each field in #spec
    <field>: <concrete-value>
}
```

---

## 3. Simple Template

### 3.1. module.cue (Simple)

**Purpose**: Main `#Module` definition with inline components and `#spec`.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package main` |
| `import` | declaration | Import `opm.dev/core@v0` |
| `core.#Module` | embedding | Declares this as a Module |
| `metadata` | `struct` | Module metadata |
| `metadata.apiVersion` | `string` | API version identifier |
| `metadata.name` | `string` | Module name (`{{.ModuleName}}`) |
| `metadata.version` | `string` | Semantic version (`{{.Version}}`) |
| `#components` | `struct` | Inline component definitions |
| `#spec` | `struct` | Configuration schema |

**Structure**:

```cue
package main

import "opm.dev/core@v0"

core.#Module

metadata: {
    apiVersion:  "{{.ModulePath}}@v0"
    name:        "{{.ModuleName}}"
    version:     "{{.Version}}"
    description: string | *"A simple OPM module"
}

#components: {
    // Inline component definitions
    <name>: {
        // Resource and trait composition
        spec: { ... }
    }
}

#spec: {
    // Configuration schema with constraints
    <field>!: <type>           // Required field
    <field>?: <type> | *<default>  // Optional with default
}
```

### 3.2. values.cue (Simple)

**Structure**:

```cue
package main

values: {
    // Matches #spec from module.cue
    <component>: {
        <field>: <concrete-value>
    }
}
```

---

## 4. Standard Template

### 4.1. module.cue (Standard)

**Purpose**: Main `#Module` definition with metadata only; components extracted.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package main` |
| `import` | declaration | Import `opm.dev/core@v0` |
| `core.#Module` | embedding | Declares this as a Module |
| `metadata` | `struct` | Module metadata |
| `#components` | reference | Reference to `_components` |
| `#spec` | `struct` | Configuration schema |

**Structure**:

```cue
package main

import "opm.dev/core@v0"

core.#Module

metadata: {
    apiVersion:  "{{.ModulePath}}@v0"
    name:        "{{.ModuleName}}"
    version:     "{{.Version}}"
    description: string | *"A standard OPM module"
}

// Reference to components defined in components.cue
#components: _components

#spec: {
    // Configuration schema
}
```

### 4.2. components.cue (Standard)

**Purpose**: Extracted component definitions.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package main` |
| `import` | declaration | Import resources and traits |
| `_components` | `struct` | Hidden field with component definitions |

**Structure**:

```cue
package main

import (
    "opm.dev/core@v0"
    // Resource and trait imports
)

_components: {
    <name>: core.#Component & {
        // Resource and trait composition
        spec: { ... }
    }
}
```

### 4.3. values.cue (Standard)

Same structure as Simple template, with values for all components defined in `components.cue`.

---

## 5. Advanced Template

### 5.1. module.cue (Advanced)

**Purpose**: Main `#Module` definition with metadata; references external definitions.

**Structure**: Same as Standard, with additional references:

```cue
package main

import "opm.dev/core@v0"

core.#Module

metadata: {
    apiVersion:  "{{.ModulePath}}@v0"
    name:        "{{.ModuleName}}"
    version:     "{{.Version}}"
    description: string | *"An advanced OPM module"
}

#components: _components  // From components.cue
#scopes: _scopes          // From scopes.cue
#policies: _policies      // From policies.cue

#spec: {
    // Configuration schema
}
```

### 5.2. components.cue (Advanced)

**Purpose**: Component composition importing from `components/` subpackage.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package main` |
| `import` | declaration | Import local `components` package |
| `_components` | `struct` | Composed components extending templates |

**Structure**:

```cue
package main

import (
    comps "{{.ModulePath}}/components"
)

_components: {
    web:    comps._web & { spec: { ... } }
    api:    comps._api & { spec: { ... } }
    worker: comps._worker & { spec: { ... } }
    db:     comps._db & { spec: { ... } }
}
```

### 5.3. scopes.cue (Advanced)

**Purpose**: Scope composition importing from `scopes/` subpackage.

**Structure**:

```cue
package main

import (
    scopes "{{.ModulePath}}/scopes"
)

_scopes: {
    frontend: scopes._frontend
    backend:  scopes._backend
}
```

### 5.4. policies.cue (Advanced)

**Purpose**: Policy definitions for the module.

**Structure**:

```cue
package main

_policies: {
    // Policy definitions
}
```

### 5.5. debug_values.cue (Advanced)

**Purpose**: Comprehensive values for `opm mod vet --concrete` validation.

**Structure**:

```cue
package main

// Extended values that fully satisfy all #spec fields
// Used for validation and debugging
values: {
    // All required fields with concrete values
    // All optional fields explicitly set
}
```

### 5.6. values.cue (Advanced)

Same structure as Standard, with values for all four components.

---

## 6. Component Templates (`components/`)

**Package**: `package components`

### 6.1. web.cue

**Purpose**: Web server component template.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package components` |
| `_web` | `#ComponentDefinition` | Hidden template field |

**Structure**:

```cue
package components

import (
    "opm.dev/core@v0"
    // Resource and trait imports
)

_web: core.#Component & {
    metadata: name: "web"
    // Resource and trait composition
    spec: {
        container: { ... }
        replicas: int
    }
}
```

### 6.2. api.cue

**Purpose**: API server component template.

**Structure**: Similar to `web.cue` with `_api` hidden field.

### 6.3. worker.cue

**Purpose**: Background worker component template.

**Structure**: Similar to `web.cue` with `_worker` hidden field.

### 6.4. db.cue

**Purpose**: Database component template with storage.

**Structure**: Similar to `web.cue` with `_db` hidden field, includes volume definitions.

---

## 7. Scope Templates (`scopes/`)

**Package**: `package scopes`

### 7.1. frontend.cue

**Purpose**: Frontend scope template for public-facing components.

**Required Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `package` | declaration | Must be `package scopes` |
| `_frontend` | `#ScopeDefinition` | Hidden template field |

**Structure**:

```cue
package scopes

import (
    "opm.dev/core@v0"
    comps "{{.ModulePath}}/components"
)

_frontend: core.#ScopeDefinition & {
    metadata: {
        name:        "frontend"
        description: "Frontend scope for public-facing components"
    }
    appliesTo: {
        components: [comps._web]
    }
    spec: { ... }
}
```

### 7.2. backend.cue

**Purpose**: Backend scope template for internal services.

**Structure**: Similar to `frontend.cue` with `_backend` hidden field.

---

## 8. File Generation Summary

| Template | Files Generated | Packages Used |
|----------|-----------------|---------------|
| simple | 3 | `main` |
| standard | 4 | `main` |
| advanced | 13 | `main`, `components`, `scopes` |
