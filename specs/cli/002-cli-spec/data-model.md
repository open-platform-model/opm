# Data Model: OPM CLI v2

**Spec**: [spec.md](./spec.md) | **Date**: 2026-01-22

This document defines the key Go types and data structures for CLI configuration and module scaffolding.

> **Note**: Render-related types (Manifest, ManifestSet, ApplyOptions, DeleteOptions, DiffResult, health types) are defined in [004-render-and-lifecycle-spec/data-model.md](../004-render-and-lifecycle-spec/data-model.md).

## Core Types

### Config

Configuration loaded from `~/.opm/config.cue` and environment variables. The CUE config is validated against an embedded CUE schema and can import provider modules for type-safe configuration.

```go
// Package: internal/config

// Config represents the OPM CLI configuration
// Loaded from ~/.opm/config.cue, validated against embedded CUE schema
type Config struct {
    // Kubeconfig is the path to the kubeconfig file
    // Env: OPM_KUBECONFIG, Default: ~/.kube/config
    Kubeconfig string `yaml:"kubeconfig,omitempty" json:"kubeconfig,omitempty"`
    
    // Context is the Kubernetes context to use
    // Env: OPM_CONTEXT, Default: current-context from kubeconfig
    Context string `yaml:"context,omitempty" json:"context,omitempty"`
    
    // Namespace is the default namespace for operations
    // Env: OPM_NAMESPACE, Default: "default"
    Namespace string `yaml:"namespace,omitempty" json:"namespace,omitempty"`
    
    // Registry is the default registry for all CUE module resolution.
    // When set, all CUE imports resolve from this registry (passed to CUE via CUE_REGISTRY).
    // Env: OPM_REGISTRY
    Registry string `yaml:"registry,omitempty" json:"registry,omitempty"`
    
    // CacheDir is the local cache directory
    // Env: OPM_CACHE_DIR, Default: ~/.opm/cache
    CacheDir string `yaml:"cacheDir,omitempty" json:"cacheDir,omitempty"`
}

// Paths contains standard filesystem paths
type Paths struct {
    ConfigFile string // ~/.opm/config.cue
    CacheDir   string // ~/.opm/cache
    HomeDir    string // ~/.opm
}

// DefaultConfig returns a Config with all default values populated
// Used by `opm config init` to generate initial config file
func DefaultConfig() *Config {
    return &Config{
        Kubeconfig: "~/.kube/config",
        Namespace:  "default",
        CacheDir:   "~/.opm/cache",
    }
}

// ResolvedValue tracks a configuration value and its resolution chain
// Used for logging config resolution with --verbose (FR-019)
type ResolvedValue struct {
    Key      string         // Configuration key (e.g., "namespace")
    Value    any            // Resolved value
    Source   string         // Source that provided the value: "flag", "env", "config", "default"
    Shadowed map[string]any // Lower-precedence sources that were overridden: source -> value
}

// OPMConfig represents the fully-loaded CUE configuration
// This includes provider definitions loaded from imports
type OPMConfig struct {
    // Config contains the basic configuration fields
    Config *Config
    
    // Registry is the resolved registry URL after applying precedence
    Registry string
    
    // RegistrySource indicates where the registry URL came from
    RegistrySource string // "flag", "env", "config"
    
    // Providers maps provider names to their loaded CUE definitions
    // Key: provider alias (e.g., "kubernetes")
    // Value: loaded CUE value referencing the provider's #Provider definition
    Providers map[string]cue.Value
}
```

### Config Schema (CUE)

Expected structure of the user's `~/.opm/config.cue` file. Generated by `opm config init`.

```cue
// ~/.opm/config.cue
package config

import (
    providers "opmodel.dev/providers@v0"
)

config: {
    // registry is the default OCI registry for module resolution.
    // Override with --registry flag or OPM_REGISTRY env var.
    registry: "registry.opmodel.dev"
    
    // kubeconfig is the path to the kubeconfig file.
    // Override with --kubeconfig flag or OPM_KUBECONFIG env var.
    kubeconfig: "~/.kube/config"
    
    // context is the Kubernetes context to use.
    // Override with --context flag or OPM_CONTEXT env var.
    // Default: current-context from kubeconfig
    context?: string
    
    // namespace is the default namespace for operations.
    // Override with --namespace flag or OPM_NAMESPACE env var.
    namespace: "default"
    
    // cacheDir is the local cache directory path.
    // Override with OPM_CACHE_DIR env var.
    cacheDir: "~/.opm/cache"
    
    // providers maps provider aliases to their definitions.
    // Providers are loaded from the registry via CUE imports.
    providers: {
        kubernetes: providers.#Registry["kubernetes"]
    }
}
```

### Config Module Metadata (CUE)

Generated alongside config.cue by `opm config init`.

```cue
// ~/.opm/cue.mod/module.cue
module: "opmodel.dev/config@v0"

language: {
    version: "v0.15.0"
}

deps: {
    "opmodel.dev/providers@v0": {
        v: "v0.1.0"
    }
}
```

### Module

Represents a loaded OPM module.

```go
// Package: internal/cue

// Module represents a loaded OPM module
type Module struct {
    // Metadata from the module definition
    Metadata ModuleMetadata
    
    // Root CUE value after loading and unification
    Value cue.Value
    
    // Directory containing the module
    Dir string
    
    // Values files that were unified
    ValuesFiles []string
}

// ModuleMetadata contains module identification information
type ModuleMetadata struct {
    // APIVersion is the module API version (e.g., "example.com/modules@v0")
    APIVersion string `json:"apiVersion"`
    
    // Name is the module name
    Name string `json:"name"`
    
    // Version is the module version (semver)
    Version string `json:"version"`
    
    // Description is an optional human-readable description
    Description string `json:"description,omitempty"`
}
```

### Version

Types for version information.

```go
// Package: internal/version

// Info contains version information
type Info struct {
    // Version is the CLI version (set via ldflags)
    Version string
    
    // GitCommit is the git commit hash
    GitCommit string
    
    // BuildDate is the build timestamp
    BuildDate string
    
    // GoVersion is the Go version used to build
    GoVersion string
    
    // CUESDKVersion is the CUE SDK version (embedded at build time)
    CUESDKVersion string
}

// CUEBinaryInfo contains CUE binary version information
type CUEBinaryInfo struct {
    // Version is the CUE binary version
    Version string
    
    // Path is the path to the CUE binary
    Path string
    
    // Compatible indicates if version matches SDK
    Compatible bool
    
    // Found indicates if CUE binary was found
    Found bool
}

// CUEVersionCompatible checks if binary version is compatible with SDK
func CUEVersionCompatible(sdkVersion, binaryVersion string) bool {
    // Compare MAJOR.MINOR only
    sdkParts := strings.Split(sdkVersion, ".")
    binParts := strings.Split(binaryVersion, ".")
    
    if len(sdkParts) < 2 || len(binParts) < 2 {
        return false
    }
    
    return sdkParts[0] == binParts[0] && sdkParts[1] == binParts[1]
}
```

### Output

Types for terminal output.

```go
// Package: internal/output

// OutputFormat specifies the output format
type OutputFormat string

const (
    FormatYAML  OutputFormat = "yaml"
    FormatJSON  OutputFormat = "json"
    FormatTable OutputFormat = "table"
    FormatDir   OutputFormat = "dir"
)
```

> **Note**: Diff, status, and styles types are defined in [004-render-and-lifecycle-spec/data-model.md](../004-render-and-lifecycle-spec/data-model.md).

## State Transitions

### Module Authoring Lifecycle

```text
┌─────────────┐     init      ┌─────────────┐
│   (none)    │ ────────────► │   Created   │
└─────────────┘               └─────────────┘
                                    │
                               vet/tidy
                                    │
                                    ▼
                              ┌─────────────┐
                              │  Validated  │
                              └─────────────┘
```

> **Note**: Deployment lifecycle (build, apply, delete) is defined in [004-render-and-lifecycle-spec](../004-render-and-lifecycle-spec/spec.md).

## Validation Rules

### Module Validation

| Field | Rule |
|-------|------|
| `metadata.apiVersion` | Required, must match pattern `domain/path@vN` |
| `metadata.name` | Required, RFC-1123 subdomain |
| `metadata.version` | Required, valid semver |
| `module.cue` | Must exist at module root |
| `values.cue` | Must exist at module root |
| `cue.mod/module.cue` | Must exist |

### Config Validation

| Field | Rule |
|-------|------|
| `config.registry` | Optional, valid URI |
| `config.kubeconfig` | Optional, valid file path |
| `config.namespace` | Optional, valid Kubernetes namespace name |
| `config.providers` | Optional, map of provider aliases to definitions |
