version: '3'

# CUE In-Memory Registry and Cache Management Tasks

# Inherits silent mode from parent Taskfile
# Override with: task --verbose <taskname> or task -v <taskname>

vars:
  CUE_CACHE_DIR:
    sh: |
      if [ -n "$CUE_CACHE_DIR" ]; then
        echo "$CUE_CACHE_DIR"
      elif [ -n "$XDG_CACHE_HOME" ]; then
        echo "$XDG_CACHE_HOME/cue"
      else
        echo "$HOME/.cache/cue"
      fi

tasks:
  # ============================================================================
  # CUE In-Memory Registry (cue mod registry)
  # ============================================================================
  # Note: This is a foreground blocking command. Use the Docker registry for
  # persistent development work (task registry:start). The CUE in-memory registry
  # is mainly useful for quick testing without Docker.

  start:
    desc: Start CUE in-memory registry server (foreground)
    summary: |
      Starts a temporary OCI registry server in memory for testing.
      This is useful for quick testing without Docker.

      IMPORTANT: This runs in the foreground and blocks your terminal.
      The server runs on a random port and prints the registry URL.
      Press Ctrl+C to stop the server.

      For persistent development work, use: task registry:start (Docker)
    cmds:
      - echo "Starting CUE in-memory registry (foreground - Ctrl+C to stop)..."
      - echo ""
      - cue mod registry

  # ============================================================================
  # CUE Module Cache Management
  # ============================================================================

  cache:path:
    desc: Show CUE cache directory path
    cmds:
      - echo "{{.CUE_CACHE_DIR}}"

  cache:info:
    desc: Show detailed cache information
    cmds:
      - |
        echo "CUE Module Cache Information:"
        echo "  Location: {{.CUE_CACHE_DIR}}"
        if [ -d "{{.CUE_CACHE_DIR}}" ]; then
          echo "  Status: Exists"
          echo "  Size: $(du -sh "{{.CUE_CACHE_DIR}}" 2>/dev/null | cut -f1)"
          echo ""
          echo "Subdirectories:"
          if [ -d "{{.CUE_CACHE_DIR}}/mod/download" ]; then
            echo "  mod/download: $(du -sh "{{.CUE_CACHE_DIR}}/mod/download" 2>/dev/null | cut -f1)"
          else
            echo "  mod/download: not found"
          fi
          if [ -d "{{.CUE_CACHE_DIR}}/mod/extract" ]; then
            echo "  mod/extract: $(du -sh "{{.CUE_CACHE_DIR}}/mod/extract" 2>/dev/null | cut -f1)"
          else
            echo "  mod/extract: not found"
          fi
        else
          echo "  Status: Does not exist"
        fi

  cache:list:
    desc: List all cached modules
    summary: |
      List all modules currently cached in the CUE module cache.
      Shows modules from both download and extract directories.
    cmds:
      - |
        echo "Cached Modules:"
        echo ""

        if [ -d "{{.CUE_CACHE_DIR}}/mod/download" ]; then
          echo "Downloaded modules:"
          find "{{.CUE_CACHE_DIR}}/mod/download" -type f -name "*.zip" 2>/dev/null | while read -r file; do
            relative="${file#{{.CUE_CACHE_DIR}}/mod/download/}"
            echo "  - $relative"
          done
          echo ""
        fi

        if [ -d "{{.CUE_CACHE_DIR}}/mod/extract" ]; then
          echo "Extracted modules:"
          find "{{.CUE_CACHE_DIR}}/mod/extract" -mindepth 1 -maxdepth 3 -type d 2>/dev/null | while read -r dir; do
            relative="${dir#{{.CUE_CACHE_DIR}}/mod/extract/}"
            echo "  - $relative"
          done
        fi

  cache:show:
    desc: Show details of a specific cached module
    summary: |
      Show detailed information about a specific module in the cache.

      Usage:
        task registry-cue:cache:show MODULE=github.com/foo/bar@v1
    vars:
      MODULE: '{{.MODULE | default ""}}'
    preconditions:
      - sh: '[ -n "{{.MODULE}}" ]'
        msg: "MODULE variable is required. Usage: task cache:show MODULE=github.com/foo/bar@v1"
    cmds:
      - |
        echo "Module: {{.MODULE}}"
        echo ""

        CACHE_DIR="{{.CUE_CACHE_DIR}}"
        MODULE_PATH="{{.MODULE}}"

        # Search in download directory
        if [ -d "$CACHE_DIR/mod/download" ]; then
          FOUND=$(find "$CACHE_DIR/mod/download" -type f -path "*${MODULE_PATH}*" 2>/dev/null)
          if [ -n "$FOUND" ]; then
            echo "Downloaded archives:"
            echo "$FOUND" | while read -r file; do
              echo "  File: $file"
              echo "  Size: $(ls -lh "$file" | awk '{print $5}')"
              echo "  Modified: $(ls -l "$file" | awk '{print $6, $7, $8}')"
            done
            echo ""
          fi
        fi

        # Search in extract directory
        if [ -d "$CACHE_DIR/mod/extract" ]; then
          FOUND=$(find "$CACHE_DIR/mod/extract" -type d -path "*${MODULE_PATH}*" 2>/dev/null)
          if [ -n "$FOUND" ]; then
            echo "Extracted modules:"
            echo "$FOUND" | while read -r dir; do
              echo "  Path: $dir"
              if [ -f "$dir/cue.mod/module.cue" ]; then
                echo "  Module file exists: yes"
              fi
            done
          fi
        fi

  cache:clear:
    desc: Clear CUE module cache
    summary: |
      Remove all cached modules from the CUE cache directory.
      This will force re-download of all modules on next use.

      Confirmation is required before deletion.
    prompt: This will delete all cached CUE modules. Continue?
    cmds:
      - |
        if [ -d "{{.CUE_CACHE_DIR}}/mod" ]; then
          echo "Clearing CUE module cache at {{.CUE_CACHE_DIR}}/mod"
          rm -rf "{{.CUE_CACHE_DIR}}/mod/download"
          rm -rf "{{.CUE_CACHE_DIR}}/mod/extract"
          echo "✓ Cache cleared successfully"
        else
          echo "Cache directory does not exist, nothing to clear"
        fi

  cache:clear:force:
    desc: Clear CUE module cache without confirmation
    summary: |
      Remove all cached modules from the CUE cache directory without prompting.
      Use with caution.
    cmds:
      - |
        if [ -d "{{.CUE_CACHE_DIR}}/mod" ]; then
          echo "Clearing CUE module cache at {{.CUE_CACHE_DIR}}/mod"
          rm -rf "{{.CUE_CACHE_DIR}}/mod/download"
          rm -rf "{{.CUE_CACHE_DIR}}/mod/extract"
          echo "✓ Cache cleared successfully"
        else
          echo "Cache directory does not exist, nothing to clear"
        fi
