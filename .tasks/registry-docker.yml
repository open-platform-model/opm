version: '3'

# Docker OCI Registry Management Tasks

# Inherits silent mode from parent Taskfile
# Override with: task --verbose <taskname> or task -v <taskname>

vars:
  REGISTRY_CONTAINER: opm-registry
  REGISTRY_PORT: 5000
  REGISTRY_IMAGE: registry:2
  REGISTRY_DATA_DIR: .registry-data
  REGISTRY_URL: localhost:5000

tasks:
  # ============================================================================
  # Registry Lifecycle
  # ============================================================================

  start:
    desc: Start Docker OCI registry
    summary: |
      Start the local OCI registry container for module publishing.

      Configuration:
        Container: {{.REGISTRY_CONTAINER}}
        Port: {{.REGISTRY_PORT}}
        Image: {{.REGISTRY_IMAGE}}
        Data: {{.REGISTRY_DATA_DIR}}

      The registry will be available at localhost:{{.REGISTRY_PORT}}
    cmds:
      - |
        if docker ps -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "Registry is already running"
        elif docker ps -a -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "Starting existing registry container..."
          docker start {{.REGISTRY_CONTAINER}}
          echo "âœ“ Registry started at {{.REGISTRY_URL}}"
        else
          echo "Creating new registry container..."
          mkdir -p "{{.REGISTRY_DATA_DIR}}"
          docker run -d \
            --name {{.REGISTRY_CONTAINER}} \
            --user $(id -u):$(id -g) \
            -p {{.REGISTRY_PORT}}:5000 \
            -v "$(realpath {{.REGISTRY_DATA_DIR}}):/var/lib/registry" \
            --restart=unless-stopped \
            {{.REGISTRY_IMAGE}}
          echo "âœ“ Registry created and started at {{.REGISTRY_URL}}"
        fi

  stop:
    desc: Stop Docker OCI registry (preserve data)
    summary: |
      Stop the registry container without removing it or its data.
      Use 'start' to restart it later.
    cmds:
      - |
        if docker ps -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "Stopping registry..."
          docker stop {{.REGISTRY_CONTAINER}}
          echo "âœ“ Registry stopped (data preserved)"
        else
          echo "Registry is not running"
        fi

  restart:
    desc: Restart Docker OCI registry
    cmds:
      - task: stop
      - task: start

  remove:
    desc: Remove registry container (preserve data)
    summary: |
      Remove the registry container but keep the data directory.
      The container can be recreated with 'start'.
    prompt: Remove registry container? Data will be preserved.
    cmds:
      - |
        if docker ps -a -f name={{.REGISTRY_CONTAINER}} -q | grep -q .; then
          echo "Removing registry container..."
          docker rm -f {{.REGISTRY_CONTAINER}}
          echo "âœ“ Container removed (data preserved in {{.REGISTRY_DATA_DIR}})"
        else
          echo "Registry container does not exist"
        fi

  # ============================================================================
  # Registry Status and Information
  # ============================================================================

  status:
    desc: Show registry status and list all modules
    summary: |
      Display the current status of the Docker registry and list all
      published modules with their versions.
    cmds:
      - |
        echo "Docker OCI Registry Status:"
        echo ""

        # Check if container exists and is running
        if docker ps -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "  Status: Running âœ“"
          echo "  Container: {{.REGISTRY_CONTAINER}}"
          echo "  URL: {{.REGISTRY_URL}}"
          echo "  Port: {{.REGISTRY_PORT}}"
          echo ""

          # List all modules
          echo "Published Modules:"
          if command -v jq >/dev/null 2>&1; then
            REPOS=$(curl -s http://{{.REGISTRY_URL}}/v2/_catalog | jq -r '.repositories[]' 2>/dev/null || echo "")
            if [ -n "$REPOS" ]; then
              echo "$REPOS" | while read -r repo; do
                TAGS=$(curl -s "http://{{.REGISTRY_URL}}/v2/$repo/tags/list" | jq -r '.tags[]?' 2>/dev/null || echo "")
                if [ -n "$TAGS" ]; then
                  echo "  â€¢ $repo"
                  echo "$TAGS" | while read -r tag; do
                    echo "    - $tag"
                  done
                else
                  echo "  â€¢ $repo (no tags)"
                fi
              done
            else
              echo "  (no modules published)"
            fi
          else
            echo "  (install 'jq' to see module list)"
            curl -s http://{{.REGISTRY_URL}}/v2/_catalog 2>/dev/null || echo "  (registry not accessible)"
          fi
        elif docker ps -a -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "  Status: Stopped"
          echo "  Container: {{.REGISTRY_CONTAINER}}"
          echo ""
          echo "Use 'task registry-docker:start' to start the registry"
        else
          echo "  Status: Not created"
          echo ""
          echo "Use 'task registry-docker:start' to create and start the registry"
        fi

  logs:
    desc: View registry logs
    summary: |
      Show logs from the registry container.
      Press Ctrl+C to stop following logs.
    cmds:
      - docker logs -f {{.REGISTRY_CONTAINER}}

  logs:tail:
    desc: View last 50 lines of registry logs
    cmds:
      - docker logs --tail 50 {{.REGISTRY_CONTAINER}}

  # ============================================================================
  # Module Management
  # ============================================================================

  list:
    desc: List all modules in registry with versions
    summary: |
      Query the OCI registry API to list all published modules and their tags.
      Requires 'jq' to be installed for formatted output.
    preconditions:
      - sh: command -v jq >/dev/null 2>&1
        msg: "jq is required. Install with: apt install jq  or  brew install jq"
    cmds:
      - |
        echo "Modules in registry ({{.REGISTRY_URL}}):"
        echo ""

        REPOS=$(curl -s http://{{.REGISTRY_URL}}/v2/_catalog | jq -r '.repositories[]' 2>/dev/null)
        if [ -z "$REPOS" ]; then
          echo "No modules found"
          exit 0
        fi

        echo "$REPOS" | while read -r repo; do
          TAGS=$(curl -s "http://{{.REGISTRY_URL}}/v2/$repo/tags/list" | jq -r '.tags[]?' 2>/dev/null)
          echo "ðŸ“¦ $repo"
          if [ -n "$TAGS" ]; then
            echo "$TAGS" | while read -r tag; do
              # Get manifest digest
              DIGEST=$(curl -sI -H "Accept: application/vnd.oci.image.manifest.v1+json" \
                "http://{{.REGISTRY_URL}}/v2/$repo/manifests/$tag" | \
                grep -i "docker-content-digest" | awk '{print $2}' | tr -d '\r')
              echo "   â€¢ $tag ${DIGEST:+(digest: ${DIGEST:0:20}...)}"
            done
          else
            echo "   (no tags)"
          fi
          echo ""
        done

  tags:
    desc: Show tags for a specific module
    summary: |
      List all tags/versions for a specific module.

      Usage:
        task registry-docker:tags MODULE=opm.dev
    vars:
      MODULE: '{{.MODULE | default ""}}'
    preconditions:
      - sh: '[ -n "{{.MODULE}}" ]'
        msg: "MODULE variable is required. Usage: task tags MODULE=opm.dev"
      - sh: command -v jq >/dev/null 2>&1
        msg: "jq is required. Install with: apt install jq  or  brew install jq"
    cmds:
      - |
        echo "Tags for {{.MODULE}}:"
        echo ""

        TAGS=$(curl -s "http://{{.REGISTRY_URL}}/v2/{{.MODULE}}/tags/list" | jq -r '.tags[]?' 2>/dev/null)
        if [ -z "$TAGS" ]; then
          echo "No tags found for {{.MODULE}}"
          echo ""
          echo "Available modules:"
          curl -s http://{{.REGISTRY_URL}}/v2/_catalog | jq -r '.repositories[]'
          exit 1
        fi

        echo "$TAGS" | while read -r tag; do
          DIGEST=$(curl -sI -H "Accept: application/vnd.oci.image.manifest.v1+json" \
            "http://{{.REGISTRY_URL}}/v2/{{.MODULE}}/manifests/$tag" | \
            grep -i "docker-content-digest" | awk '{print $2}' | tr -d '\r')
          echo "  â€¢ $tag"
          echo "    Digest: $DIGEST"
        done

  show:
    desc: Show detailed information about a specific module version
    summary: |
      Display detailed manifest information for a specific module and tag.

      Usage:
        task registry-docker:show MODULE=opm.dev TAG=v1
    vars:
      MODULE: '{{.MODULE | default ""}}'
      TAG: '{{.TAG | default "latest"}}'
    preconditions:
      - sh: '[ -n "{{.MODULE}}" ]'
        msg: "MODULE variable is required. Usage: task show MODULE=opm.dev TAG=v1"
      - sh: command -v jq >/dev/null 2>&1
        msg: "jq is required"
    cmds:
      - |
        echo "Module: {{.MODULE}}@{{.TAG}}"
        echo ""

        MANIFEST=$(curl -s -H "Accept: application/vnd.oci.image.manifest.v1+json" \
          "http://{{.REGISTRY_URL}}/v2/{{.MODULE}}/manifests/{{.TAG}}")

        if echo "$MANIFEST" | jq -e '.errors' >/dev/null 2>&1; then
          echo "Error: Module or tag not found"
          echo "$MANIFEST" | jq '.errors'
          exit 1
        fi

        echo "$MANIFEST" | jq '.'

  delete:
    desc: Delete a specific module tag
    summary: |
      Delete a specific version (tag) of a module from the registry.

      Usage:
        task registry-docker:delete MODULE=opm.dev TAG=v1

      WARNING: This action cannot be undone.
    vars:
      MODULE: '{{.MODULE | default ""}}'
      TAG: '{{.TAG | default ""}}'
    preconditions:
      - sh: '[ -n "{{.MODULE}}" ]'
        msg: "MODULE variable is required"
      - sh: '[ -n "{{.TAG}}" ]'
        msg: "TAG variable is required"
    prompt: Delete {{.MODULE}}@{{.TAG}} from registry?
    cmds:
      - |
        echo "Deleting {{.MODULE}}@{{.TAG}}..."

        # Get manifest digest
        DIGEST=$(curl -sI -H "Accept: application/vnd.oci.image.manifest.v1+json" \
          "http://{{.REGISTRY_URL}}/v2/{{.MODULE}}/manifests/{{.TAG}}" | \
          grep -i "docker-content-digest" | awk '{print $2}' | tr -d '\r')

        if [ -z "$DIGEST" ]; then
          echo "Error: Could not find digest for {{.MODULE}}@{{.TAG}}"
          exit 1
        fi

        # Delete by digest
        curl -X DELETE "http://{{.REGISTRY_URL}}/v2/{{.MODULE}}/manifests/$DIGEST"
        echo ""
        echo "âœ“ Deleted {{.MODULE}}@{{.TAG}}"

  # ============================================================================
  # Cleanup Operations
  # ============================================================================

  cleanup:
    desc: Remove all registry data
    summary: |
      Stop the registry, remove the container, and delete all data.

      WARNING: This will delete all published modules.
    prompt: Delete ALL registry data? This cannot be undone.
    cmds:
      - |
        # Stop container if running
        if docker ps -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "Stopping registry..."
          docker stop {{.REGISTRY_CONTAINER}}
        fi

        # Remove container if exists
        if docker ps -a -f name={{.REGISTRY_CONTAINER}} -q | grep -q .; then
          echo "Removing registry container..."
          docker rm -f {{.REGISTRY_CONTAINER}}
          echo "âœ“ Container removed"
        fi

        # Remove data directory
        if [ -d "{{.REGISTRY_DATA_DIR}}" ]; then
          echo "Removing registry data..."
          rm -rf "{{.REGISTRY_DATA_DIR}}"
          echo "âœ“ All registry data removed"
        fi

  cleanup:force:
    desc: Force cleanup without confirmation
    cmds:
      - docker rm -f {{.REGISTRY_CONTAINER}} 2>/dev/null || true
      - |
        if [ -d "{{.REGISTRY_DATA_DIR}}" ]; then
          rm -rf "{{.REGISTRY_DATA_DIR}}"
          echo "âœ“ Registry cleanup complete"
        fi

  reset:
    desc: Full reset (stop + cleanup + clear cache)
    summary: |
      Complete reset of the registry system:
      1. Stop and remove container
      2. Delete all registry data
      3. Clear CUE module cache

      This gives you a completely clean slate.
    prompt: Perform full reset? All registry data and cache will be deleted.
    cmds:
      - task: cleanup:force
      - task: registry-cue:cache:clear:force
      - echo "âœ“ Full reset complete"

  # ============================================================================
  # Health Checks
  # ============================================================================

  health:
    desc: Check registry health
    summary: |
      Perform health checks on the registry to ensure it's functioning correctly.
    cmds:
      - |
        echo "Registry Health Check:"
        echo ""

        # Check if container is running
        if ! docker ps -f name={{.REGISTRY_CONTAINER}} | grep -q {{.REGISTRY_CONTAINER}}; then
          echo "âœ— Container is not running"
          exit 1
        fi
        echo "âœ“ Container is running"

        # Check if port is accessible
        if ! curl -sf http://{{.REGISTRY_URL}}/v2/ >/dev/null; then
          echo "âœ— Registry API not accessible"
          exit 1
        fi
        echo "âœ“ Registry API accessible"

        # Check catalog endpoint
        if ! curl -sf http://{{.REGISTRY_URL}}/v2/_catalog >/dev/null; then
          echo "âœ— Catalog endpoint not working"
          exit 1
        fi
        echo "âœ“ Catalog endpoint working"

        echo ""
        echo "All health checks passed âœ“"

  ping:
    desc: Quick ping to check if registry is responding
    cmds:
      - curl -sf http://{{.REGISTRY_URL}}/v2/ && echo "âœ“ Registry is responding" || echo "âœ— Registry is not responding"
